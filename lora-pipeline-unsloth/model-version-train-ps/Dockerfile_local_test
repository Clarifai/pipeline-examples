FROM nvidia/cuda:12.4.0-devel-ubuntu22.04

# Install Python 3.11 and build dependencies
RUN apt-get update && apt-get install -y \
    python3.11 \
    python3.11-dev \
    python3-pip \
    git \
    build-essential \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# Set CUDA environment variables for building extensions
ENV CUDA_HOME=/usr/local/cuda \
    PATH=/usr/local/cuda/bin:$PATH \
    LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH \
    TORCH_CUDA_ARCH_LIST="8.0;9.0"

# Set python3.11 as default
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

# Install PyTorch matching the working conda env (2.7.0+cu128)
RUN pip install --no-cache-dir torch==2.7.0 torchvision --index-url https://download.pytorch.org/whl/cu128

COPY --link requirements.txt /home/nonroot/requirements.txt
# Install requirements except unsloth first
RUN grep -v "unsloth" /home/nonroot/requirements.txt > /tmp/requirements_no_unsloth.txt && \
    pip install --no-cache-dir -r /tmp/requirements_no_unsloth.txt
# Install unsloth without dependencies (to skip xformers), then install missing deps
ENV XFORMERS_DISABLED=1
RUN pip install --no-cache-dir --no-deps unsloth==2025.7.8 unsloth_zoo==2025.7.10

COPY --link=true 1 /home/nonroot/main/1
COPY --link=true requirements.txt config.yaml /home/nonroot/main/

WORKDIR /home/nonroot/main

ENV CLARIFAI_PAT=${CLARIFAI_PAT} \
    PYTHONPATH=/home/nonroot/main

# Keep container running for manual testing
CMD ["tail", "-f", "/dev/null"]
