FROM --platform=linux/amd64 pytorch/pytorch:2.5.1-cuda12.4-cudnn9-devel

RUN apt-get update && apt-get install -y \
    git \
    && rm -rf /var/lib/apt/lists/*

COPY --link requirements.txt /home/nonroot/requirements.txt
# Install all deps except unsloth first (avoids xformers build issues)
RUN grep -v "unsloth" /home/nonroot/requirements.txt > /tmp/requirements_no_unsloth.txt && \
    pip install --no-cache-dir -r /tmp/requirements_no_unsloth.txt
# Install unsloth without pulling xformers (which fails to build on some platforms)
ENV XFORMERS_DISABLED=1
RUN pip install --no-cache-dir --no-deps unsloth==2025.7.8 unsloth_zoo==2025.7.10

COPY --link=true 1 /home/nonroot/main/1
COPY --link=true requirements.txt config.yaml /home/nonroot/main/

WORKDIR /home/nonroot/main

ENV CLARIFAI_PAT=${CLARIFAI_PAT} \
    PYTHONPATH=/home/nonroot/main

# Keep container running for manual testing
CMD ["tail", "-f", "/dev/null"]
