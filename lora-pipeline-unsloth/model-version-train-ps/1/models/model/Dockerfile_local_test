# syntax=docker/dockerfile:1.13-labs
# Build context: model-version-train-ps/1/
# docker build --platform linux/arm64 -f models/model/Dockerfile_local_test -t lora-serve-test .
# docker run --gpus all --rm -d -e CLARIFAI_PAT=$CLARIFAI_PAT lora-serve-test
#
# Exec in and run:
#   docker exec -it <ctr> bash
#   cd /home/nonroot/main && python test_model.py
#
# Difference from Dockerfil:
#   - build context is 1/ (needs test_model.py at root)
#   - model code goes under models/model/1/ (dev layout test_model.py expects)
#   - entrypoint is tail so the container stays up for manual exec
FROM --platform=linux/arm64 vllm/vllm-openai:v0.15.1 as final

COPY --link models/model/requiremen.txt /home/nonroot/requirements.txt

# vllm base image bundles vllm, torch, CUDA. Install remaining deps on top.
RUN ["pip", "install", "--no-cache-dir", "-r", "/home/nonroot/requirements.txt"]
RUN ["pip", "show", "--no-cache-dir", "clarifai"]

ENV NUMBA_CACHE_DIR=/tmp/numba_cache \
    TORCHINDUCTOR_CACHE_DIR=/tmp/torchinductor_cache \
    HOME=/tmp \
    DEBIAN_FRONTEND=noninteractive

# Copy model code into the dev directory layout that test_model.py expects:
#   test_model.py inserts dirname(__file__)/models into sys.path then does
#   importlib.import_module("model.1.model") -> models/model/1/model.py
COPY --link=true models/model/1 /home/nonroot/main/models/model/1
COPY --link=true models/model/config.yaml /home/nonroot/main/models/model/config.yaml
COPY --link=true models/model/config.yaml /home/nonroot/main/config.yaml
COPY --link=true models/model/requiremen.txt /home/nonroot/main/requiremen.txt
COPY --link=true test_model.py /home/nonroot/main/test_model.py

ENV PYTHONPATH=${PYTHONPATH}:/home/nonroot/main \
    CLARIFAI_PAT=${CLARIFAI_PAT} \
    CLARIFAI_API_BASE=${CLARIFAI_API_BASE:-https://api.clarifai.com}

USER root
RUN echo "nonroot:x:65532:65532:nonroot user:/home/nonroot:/sbin/nologin" >> /etc/passwd && \
    ln -sf /usr/bin/python3 /usr/bin/python && \
    chown -R 65532:65532 /home/nonroot/main
USER nonroot

WORKDIR /home/nonroot/main

ENTRYPOINT []
CMD ["tail", "-f", "/dev/null"]
